<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarkEngine Multiplayer Game</title>
    <style>
        body {
            margin: 0;
            display: flex;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }

        #gameContainer {
            width: 800px;
            margin: 20px;
        }

        #gameCanvas {
            background: #333;
            border: 2px solid #444;
        }

        #sidebar {
            width: 300px;
            margin: 20px;
        }

        #chatBox {
            height: 300px;
            background: #333;
            border: 2px solid #444;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
        }

        #chatInput {
            width: 100%;
            padding: 8px;
            background: #444;
            border: none;
            color: white;
            margin-bottom: 10px;
        }

        .message {
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        #playersList {
            background: #333;
            border: 2px solid #444;
            padding: 10px;
            margin-top: 20px;
        }

        .player {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>
    <div id="sidebar">
        <div id="chatBox"></div>
        <input type="text" id="chatInput" placeholder="Type a message...">
        <div id="playersList">
            <h3>Players Online</h3>
            <div id="playersContainer"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const chatBox = document.getElementById('chatBox');
        const chatInput = document.getElementById('chatInput');
        const playersContainer = document.getElementById('playersContainer');
        const statusDiv = document.getElementById('connectionStatus');

        let myId = null;
        let players = new Map();
        let localPlayer = {
            x: Math.random() * (canvas.width - 40),
            y: Math.random() * (canvas.height - 40),
            color: '#' + Math.floor(Math.random()*16777215).toString(16),
            name: 'Player' + Math.floor(Math.random() * 1000)
        };

        // Status display functions
        function updateStatus(message, isError = false) {
            statusDiv.style.color = isError ? '#ff4444' : '#44ff44';
            statusDiv.textContent = message;
            console.log(message);
        }

        function updateStatus(message, isError = false) {
            statusDiv.style.color = isError ? '#ff4444' : '#44ff44';
            statusDiv.textContent = message;
            console.log(message);
        }

        // Connect to WebSocket server
        const socket = io('https://barkengine-server.glitch.me');

        // Connection events
        socket.on('connect', () => {
            myId = socket.id;
            players.set(myId, localPlayer);
            updateStatus('Connected to game server!');
            
            // Send initial player data
            socket.emit('player_join', {
                id: myId,
                player: localPlayer
            });
        });

        socket.on('disconnect', () => {
            updateStatus('Disconnected from server. Trying to reconnect...', true);
        });

        socket.on('player_join', (data) => {
            if (data.id !== myId) {
                players.set(data.id, data.player);
                updateStatus(`${data.player.name} joined the game`);
                updatePlayersList();
            }
        });

        socket.on('player_leave', (id) => {
            if (players.has(id)) {
                const playerName = players.get(id).name;
                players.delete(id);
                updateStatus(`${playerName} left the game`);
                updatePlayersList();
            }
        });

        socket.on('player_list', (playerList) => {
            Object.entries(playerList).forEach(([id, player]) => {
                if (id !== myId) {
                    players.set(id, player);
                }
            });
            updatePlayersList();
        });

        socket.on('player_move', (data) => {
            if (data.id !== myId && players.has(data.id)) {
                const player = players.get(data.id);
                player.x = data.x;
                player.y = data.y;
            }
        });

        socket.on('chat_message', (data) => {
            if (data.id !== myId) {
                addChatMessage(data.id, data.message);
            }
        });

        // Add a share button to let others join
        const shareButton = document.createElement('button');
        shareButton.textContent = 'Share Game Link';
        shareButton.style.marginTop = '10px';
        shareButton.onclick = () => {
            const gameUrl = window.location.href;
            navigator.clipboard.writeText(gameUrl);
            alert('Game link copied to clipboard! Share this with your friends to let them join.');
        };
        document.getElementById('sidebar').appendChild(shareButton);



        // Game loop
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw all players
            players.forEach((player, id) => {
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, 40, 40);
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(player.name, player.x, player.y - 5);
            });

            requestAnimationFrame(gameLoop);
        }

        // Movement controls
        const keys = new Set();
        const SPEED = 5;

        document.addEventListener('keydown', (e) => {
            keys.add(e.key);
            
            const oldX = localPlayer.x;
            const oldY = localPlayer.y;

            if (keys.has('ArrowLeft') && localPlayer.x > 0) localPlayer.x -= SPEED;
            if (keys.has('ArrowRight') && localPlayer.x < canvas.width - 40) localPlayer.x += SPEED;
            if (keys.has('ArrowUp') && localPlayer.y > 0) localPlayer.y -= SPEED;
            if (keys.has('ArrowDown') && localPlayer.y < canvas.height - 40) localPlayer.y += SPEED;

            // Send position update if moved
            if (oldX !== localPlayer.x || oldY !== localPlayer.y) {
                socket.emit('player_move', {
                    id: myId,
                    x: localPlayer.x,
                    y: localPlayer.y
                });
            }
        });

        document.addEventListener('keyup', (e) => {
            keys.delete(e.key);
        });

        // Chat functionality
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && chatInput.value.trim()) {
                const message = chatInput.value.trim();
                addChatMessage(myId, message);
                
                // Send chat message to server
                socket.emit('chat_message', {
                    id: myId,
                    message: message
                });

                chatInput.value = '';
            }
        });

        function addChatMessage(peerId, message) {
            const player = players.get(peerId);
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.style.color = player.color;
            messageDiv.textContent = `${player.name}: ${message}`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function updatePlayersList() {
            playersContainer.innerHTML = '';
            players.forEach((player, id) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player';
                playerDiv.style.color = player.color;
                playerDiv.textContent = `${player.name} ${id === myId ? '(You)' : ''}`;
                
                if (id !== myId && !connections.has(id)) {
                    const connectButton = document.createElement('button');
                    connectButton.textContent = 'Connect';
                    connectButton.onclick = () => connectToPeer(id);
                    playerDiv.appendChild(connectButton);
                }
                
                playersContainer.appendChild(playerDiv);
            });
        }

        // Start the game
        gameLoop();
    </script>
</body>
</html>
