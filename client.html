<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarkEngine Multiplayer Game</title>
    <style>
        body {
            margin: 0;
            display: flex;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }

        #gameContainer {
            width: 800px;
            margin: 20px;
        }

        #gameCanvas {
            background: #333;
            border: 2px solid #444;
        }

        #sidebar {
            width: 300px;
            margin: 20px;
        }

        #chatBox {
            height: 300px;
            background: #333;
            border: 2px solid #444;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
        }

        #chatInput {
            width: 100%;
            padding: 8px;
            background: #444;
            border: none;
            color: white;
            margin-bottom: 10px;
        }

        .message {
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        #playersList {
            background: #333;
            border: 2px solid #444;
            padding: 10px;
            margin-top: 20px;
        }

        .player {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>
    <div id="sidebar">
        <div id="chatBox"></div>
        <input type="text" id="chatInput" placeholder="Type a message...">
        <div id="playersList">
            <h3>Players Online</h3>
            <div id="playersContainer"></div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const chatBox = document.getElementById('chatBox');
        const chatInput = document.getElementById('chatInput');
        const playersContainer = document.getElementById('playersContainer');

        let myId = null;
        let players = new Map();
        let connections = new Map();
        let localPlayer = {
            x: Math.random() * (canvas.width - 40),
            y: Math.random() * (canvas.height - 40),
            color: '#' + Math.floor(Math.random()*16777215).toString(16),
            name: 'Player' + Math.floor(Math.random() * 1000)
        };

        // Add status display
        const statusDiv = document.createElement('div');
        statusDiv.id = 'connectionStatus';
        statusDiv.style.background = '#333';
        statusDiv.style.padding = '10px';
        statusDiv.style.marginBottom = '10px';
        statusDiv.style.border = '2px solid #444';
        document.getElementById('sidebar').insertBefore(statusDiv, document.getElementById('chatBox'));

        function updateStatus(message, isError = false) {
            statusDiv.style.color = isError ? '#ff4444' : '#44ff44';
            statusDiv.textContent = message;
            console.log(message);
        }

        // Initialize PeerJS with a room prefix to avoid collisions with other games
        const roomPrefix = 'barkengine-';
        const peer = new Peer({
            debug: 2, // Enable debug logs
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ]
            }
        });
        
        peer.on('open', (id) => {
            myId = id;
            players.set(id, localPlayer);
            updatePlayersList();
            updateStatus('Connected to PeerJS server! Your ID: ' + id);
            
            // List all peers in our room
            peer.listAllPeers(peers => {
                updateStatus('Found ' + peers.length + ' peers');
                console.log('All peers:', peers);
                peers.forEach(peerId => {
                    if (peerId !== id) {
                        updateStatus('Attempting to connect to peer: ' + peerId);
                        connectToPeer(peerId);
                    }
                });
            });

            // Start periodic peer discovery
            setInterval(() => {
                peer.listAllPeers(peers => {
                    peers.forEach(peerId => {
                        if (peerId !== id && !connections.has(peerId)) {
                            updateStatus('Found new peer: ' + peerId);
                            connectToPeer(peerId);
                        }
                    });
                });
            }, 5000); // Check for new peers every 5 seconds
        });

        // Handle incoming connections
        peer.on('connection', (conn) => {
            updateStatus('Incoming connection from: ' + conn.peer);
            handleConnection(conn);
        });

        // Add connection error handling
        peer.on('error', (err) => {
            updateStatus('PeerJS error: ' + err.type + ' - ' + err.message, true);
            console.error('PeerJS error:', err);
            if (err.type === 'peer-unavailable') {
                const peerId = err.message.split(' ')[1];
                players.delete(peerId);
                connections.delete(peerId);
                updatePlayersList();
            }
        });

        // Add disconnection handling
        peer.on('disconnected', () => {
            updateStatus('Disconnected from PeerJS server. Attempting to reconnect...', true);
            peer.reconnect();
        });

        peer.on('close', () => {
            updateStatus('Connection to PeerJS server closed', true);
        });

        // Add a share button to let others join
        const shareButton = document.createElement('button');
        shareButton.textContent = 'Share Game Link';
        shareButton.style.marginTop = '10px';
        shareButton.onclick = () => {
            const gameUrl = window.location.href;
            navigator.clipboard.writeText(gameUrl);
            alert('Game link copied to clipboard! Share this with your friends to let them join.');
        };
        document.getElementById('sidebar').appendChild(shareButton);

        function handleConnection(conn) {
            updateStatus('New connection established with: ' + conn.peer);
            connections.set(conn.peer, conn);
            
            // Send local player data to new connection
            conn.on('open', () => {
                updateStatus('Connection opened with: ' + conn.peer);
                conn.send({
                    type: 'init',
                    player: localPlayer
                });
            });

            // Handle incoming data
            conn.on('data', (data) => {
                switch(data.type) {
                    case 'init':
                        updateStatus('Received init data from: ' + conn.peer);
                        players.set(conn.peer, data.player);
                        updatePlayersList();
                        break;
                    case 'move':
                        if (players.has(conn.peer)) {
                            const player = players.get(conn.peer);
                            player.x = data.x;
                            player.y = data.y;
                        }
                        break;
                    case 'chat':
                        addChatMessage(conn.peer, data.message);
                        break;
                }
            });

            conn.on('close', () => {
                updateStatus('Connection closed with: ' + conn.peer, true);
                players.delete(conn.peer);
                connections.delete(conn.peer);
                updatePlayersList();
            });

            conn.on('error', (err) => {
                updateStatus('Connection error with ' + conn.peer + ': ' + err.message, true);
            });
        }

        // Connect to a new peer
        function connectToPeer(peerId) {
            if (peerId === myId || connections.has(peerId)) return;
            const conn = peer.connect(peerId);
            handleConnection(conn);
        }

        // Game loop
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw all players
            players.forEach((player, id) => {
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, 40, 40);
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(player.name, player.x, player.y - 5);
            });

            requestAnimationFrame(gameLoop);
        }

        // Movement controls
        const keys = new Set();
        const SPEED = 5;

        document.addEventListener('keydown', (e) => {
            keys.add(e.key);
            
            const oldX = localPlayer.x;
            const oldY = localPlayer.y;

            if (keys.has('ArrowLeft') && localPlayer.x > 0) localPlayer.x -= SPEED;
            if (keys.has('ArrowRight') && localPlayer.x < canvas.width - 40) localPlayer.x += SPEED;
            if (keys.has('ArrowUp') && localPlayer.y > 0) localPlayer.y -= SPEED;
            if (keys.has('ArrowDown') && localPlayer.y < canvas.height - 40) localPlayer.y += SPEED;

            // Send position update if moved
            if (oldX !== localPlayer.x || oldY !== localPlayer.y) {
                const moveData = {
                    type: 'move',
                    x: localPlayer.x,
                    y: localPlayer.y
                };
                
                connections.forEach(conn => {
                    conn.send(moveData);
                });
            }
        });

        document.addEventListener('keyup', (e) => {
            keys.delete(e.key);
        });

        // Chat functionality
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && chatInput.value.trim()) {
                const message = chatInput.value.trim();
                addChatMessage(myId, message);
                
                // Send chat message to all peers
                connections.forEach(conn => {
                    conn.send({
                        type: 'chat',
                        message: message
                    });
                });

                chatInput.value = '';
            }
        });

        function addChatMessage(peerId, message) {
            const player = players.get(peerId);
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.style.color = player.color;
            messageDiv.textContent = `${player.name}: ${message}`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function updatePlayersList() {
            playersContainer.innerHTML = '';
            players.forEach((player, id) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player';
                playerDiv.style.color = player.color;
                playerDiv.textContent = `${player.name} ${id === myId ? '(You)' : ''}`;
                
                if (id !== myId && !connections.has(id)) {
                    const connectButton = document.createElement('button');
                    connectButton.textContent = 'Connect';
                    connectButton.onclick = () => connectToPeer(id);
                    playerDiv.appendChild(connectButton);
                }
                
                playersContainer.appendChild(playerDiv);
            });
        }

        // Start the game
        gameLoop();
    </script>
</body>
</html>
